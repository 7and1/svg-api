name: Build Icons

on:
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild all icons"
        type: boolean
        default: false

concurrency:
  group: build-icons
  cancel-in-progress: false

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10"

jobs:
  build:
    name: Build and Upload Icons
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Test icons package
        run: pnpm --filter @svg-api/icons test

      - name: Build icons
        run: pnpm --filter @svg-api/icons build

      - name: Upload icons to R2 + KV
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_KV_NAMESPACE_ID: ${{ secrets.CF_KV_NAMESPACE_ID }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: pnpm --filter @svg-api/icons upload

      - name: Summary
        run: |
          echo "## Icons Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Built at: $(date -u)" >> $GITHUB_STEP_SUMMARY
          if [ -f packages/icons/dist/manifest.json ]; then
            echo "- Total icons: $(jq '.totalIcons // "N/A"' packages/icons/dist/manifest.json)" >> $GITHUB_STEP_SUMMARY
          fi
